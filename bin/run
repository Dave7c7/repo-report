#!/usr/bin/env node
/* eslint-disable no-throw-literal */

'use strict';

require('dotenv').config();
const Metrics = require('../config/metrics.js');
const Yargs = require('yargs');
const colors = require('colors/safe');
const homedir = require('os').homedir();
const path = require('path');

const symbols = require('../src/symbols');
const detail = require('../src/commands/detail');
const { isConfigValid } = require('../src/utils');

const {
	GH_TOKEN,
	GITHUB_TOKEN,
	XDG_CONFIG_HOME,
	XDG_CACHE_DIR,
} = process.env;

// Variable to prevent calling isConfigValid twice
let configValidated;
const defaultConfigPaths = [].concat(
	XDG_CONFIG_HOME ? path.join(XDG_CONFIG_HOME, 'repo-report.json') : [],
	path.join(homedir, '.repo-report.json'),
);
const cachePath = XDG_CACHE_DIR ? path.join(XDG_CACHE_DIR, '.repo-report') : path.join(homedir, '.repo-report', 'cache');

const getCommandMeta = (yargs) => yargs
	.usage('Usage: $0 [options]')

	.option('unactionable', {
		describe: `Shows values of metrics you lack permissions to change, with a ${symbols.unactionable} next to it`,
	})
	.option('actual', {
		describe: 'Show metricsâ€™ true values',
	})
	.option('all', {
		describe: 'Show all metrics',
	})
	.option('goodness', {
		describe: 'Prefix actual values with goodness values',
	})
	.option('f', {
		choices: [
			'sources',
			'forks',
			'templates',
			'private',
			'public',
		],
		describe: 'Focus repo types',
	})
	.option('p', {
		alias: 'pick',
		choices: Object.keys(Metrics),
		describe: 'Pick metrics',

	})
	.option('cache', {
		default: false,
		describe: 'Dump API requests and cleaned up data in `--cacheDir` path',
	})
	.option('cacheDir', {
		default: cachePath,
		normalize: true,
	})
	.hide('cacheDir')
	.alias('s', 'sort')
	.boolean('s')
	.describe('s', 'Sort repos alphabetically')
	.alias('m', 'metrics')
	.boolean('m')
	.describe('m', 'Show available metrics')
	.help('h')
	.alias('h', 'help')
	.strict();

Yargs.usage('Usage: $0 <command> [options]')
	.default('config', null)
	.check(({ config }) => {
		if (configValidated) {
			return true;
		}
		configValidated = true;
		const configPaths = [].concat(
			config || [],
			defaultConfigPaths,
		);
		const { valid, error } = isConfigValid(configPaths);
		if (!valid) {
			throw `${symbols.error} ${colors.red(error)}`;
		}
		return true;
	})
	.default('token', GH_TOKEN || GITHUB_TOKEN)
	.hide('token')
	.check(({ token }) => {
		if (token) {
			return true;
		}
		throw colors.red(`${symbols.error} env variable GH_TOKEN or GITHUB_TOKEN not found. Refer to #Installation in README.md on how to set an env variable`);
	})
	.command(
		'$0',
		`Fetch actionable details about your public, source (non-fork, non-template) repositories. Unactionable metrics are converted to ${symbols.success} by default.`,
		(yargs) => {
			const { argv } = getCommandMeta(yargs);
			detail(argv);
		},
	)
	.command(
		'ls',
		'Lists all repositories. Includes sources, forks, templates, private and public repos by default. Shows DefBranch and Access metrics by default.',
		(yargs) => {
			const { argv } = getCommandMeta(yargs);
			detail({
				actual: true,
				f: ['sources', 'forks', 'templates', 'private', 'public'],
				p: ['DefBranch', 'Access'],
				pick: ['DefBranch', 'Access'],
				...argv,
			});
		},
	)
	.help('h')
	.alias('h', 'help')
	.parse();
